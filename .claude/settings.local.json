{
  "permissions": {
    "allow": [
      "Bash(python:*)",
      "Bash(C:UsersUSERanaconda3python.exe parse_cura_printers.py)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\":*)",
      "Read(//c/Users/USER/FACTOR HIBRID/FACTOR-HIBRID-r1.0/packages/web/**)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" test_cura.py)",
      "Bash(del /Q test_cura.py test_upload_stl.py test_auto_convert.py)",
      "Bash(git add:*)",
      "Read(//c/Program Files/UltiMaker Cura 5.7.1/share/cura/resources/definitions/**)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" test_all_printers.py)",
      "Bash(pkill:*)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" test_cura_direct.py)",
      "Bash(for f in c:/Users/USER/factor_AI_python/output/*.gcode)",
      "Bash(tail:*)",
      "Bash(done)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c:*)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" test_live_stream.py)",
      "Bash(dir /b \"c:\\Users\\USER\\factor_AI_python\\*.py\")",
      "Bash(dir \"c:\\Users\\USER\\factor_AI_python\" /b)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(ls:*)",
      "Bash(file:*)",
      "Bash(cat:*)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\n# Read the file\nwith open(''c:/Users/USER/factor_AI_python/gcode_analyzer/api/router.py'', ''r'', encoding=''utf-8'') as f:\n    content = f.read()\n\n# Find where to insert new endpoints (after the analyze endpoint)\ninsert_after = ''''''    return {\n        \"\"analysis_id\"\": analysis_id,\n        \"\"status\"\": \"\"pending\"\",\n        \"\"message\"\": \"\"G-code 분석이 시작되었습니다.\"\",\n        \"\"stream_url\"\": f\"\"/api/v1/gcode/analysis/{analysis_id}/stream\"\"\n    }\n\n@router.get(\"\"/analysis/{analysis_id}\"\")''''''\n\nnew_endpoints = ''''''    return {\n        \"\"analysis_id\"\": analysis_id,\n        \"\"status\"\": \"\"pending\"\",\n        \"\"message\"\": \"\"G-code 분석이 시작되었습니다.\"\",\n        \"\"stream_url\"\": f\"\"/api/v1/gcode/analysis/{analysis_id}/stream\"\"\n    }\n\n\n@router.post(\"\"/summary\"\")\nasync def analyze_gcode_summary_only(request: GCodeSummaryRequest, background_tasks: BackgroundTasks):\n    \"\"\"\"\"\"\n    G-code 요약만 분석 (LLM 분석 없음 - 빠름)\n    \n    온도, 피드, 서포트 비율, 예상 출력 시간 등의 요약 정보만 추출합니다.\n    에러 분석은 수행하지 않습니다.\n    \n    - gcode_content: G-code 문자열\n    - printer_info: 프린터 정보 (선택)\n    - filament_type: 필라멘트 타입 (선택)\n    \n    Returns: analysis_id (요약 결과 조회에 사용)\n    \"\"\"\"\"\"\n    analysis_id = request.analysis_id or str(uuid.uuid4())\n    \n    # 임시 파일 생성\n    output_dir = os.getenv(\"\"OUTPUT_DIR\"\", \"\"./output\"\")\n    os.makedirs(output_dir, exist_ok=True)\n    \n    temp_file_path = os.path.join(output_dir, f\"\"gcode_summary_{analysis_id}.gcode\"\")\n    with open(temp_file_path, ''w'', encoding=''utf-8'') as f:\n        f.write(request.gcode_content)\n    \n    # 분석 상태 초기화\n    gcode_analysis_store[analysis_id] = {\n        \"\"status\"\": \"\"pending\"\",\n        \"\"progress\"\": 0.0,\n        \"\"current_step\"\": \"\"initializing\"\",\n        \"\"analysis_mode\"\": \"\"summary_only\"\",\n        \"\"timeline\"\": [],\n        \"\"temp_file\"\": temp_file_path,\n        \"\"printer_info\"\": request.printer_info.dict() if request.printer_info else None,\n        \"\"filament_type\"\": request.filament_type,\n        \"\"user_id\"\": request.user_id,\n        \"\"result\"\": None,\n        \"\"comprehensive_summary\"\": None,\n        \"\"error\"\": None,\n        \"\"created_at\"\": datetime.now().isoformat()\n    }\n    \n    logger.info(f\"\"[GCode] Summary analysis started: {analysis_id}\"\")\n    \n    # 백그라운드에서 요약 분석 실행\n    background_tasks.add_task(run_gcode_summary_task, analysis_id)\n    \n    return {\n        \"\"analysis_id\"\": analysis_id,\n        \"\"status\"\": \"\"pending\"\",\n        \"\"analysis_mode\"\": \"\"summary_only\"\",\n        \"\"message\"\": \"\"G-code 요약 분석이 시작되었습니다. (LLM 분석 없음)\"\",\n        \"\"summary_url\"\": f\"\"/api/v1/gcode/analysis/{analysis_id}/summary\"\"\n    }\n\n\n@router.get(\"\"/analysis/{analysis_id}/summary\"\")\nasync def get_gcode_summary(analysis_id: str):\n    \"\"\"\"\"\"\n    종합 요약 결과만 조회\n    \n    온도, 피드, 서포트 비율, 예상 출력 시간 등의 요약 정보 반환\n    \"\"\"\"\"\"\n    if analysis_id not in gcode_analysis_store:\n        raise HTTPException(status_code=404, detail=\"\"분석을 찾을 수 없습니다.\"\")\n    \n    data = gcode_analysis_store[analysis_id]\n    \n    if data[\"\"status\"\"] not in [\"\"completed\"\", \"\"summary_completed\"\"]:\n        return {\n            \"\"analysis_id\"\": analysis_id,\n            \"\"status\"\": data[\"\"status\"\"],\n            \"\"progress\"\": data[\"\"progress\"\"],\n            \"\"message\"\": \"\"분석이 아직 완료되지 않았습니다.\"\"\n        }\n    \n    comprehensive_summary = data.get(\"\"comprehensive_summary\"\") or data.get(\"\"result\"\", {}).get(\"\"comprehensive_summary\"\")\n    \n    return {\n        \"\"analysis_id\"\": analysis_id,\n        \"\"status\"\": data[\"\"status\"\"],\n        \"\"analysis_mode\"\": data.get(\"\"analysis_mode\"\", \"\"full\"\"),\n        \"\"comprehensive_summary\"\": comprehensive_summary,\n        \"\"timeline\"\": data.get(\"\"timeline\"\", [])\n    }\n\n\n@router.post(\"\"/analysis/{analysis_id}/error-analysis\"\")\nasync def run_error_analysis(analysis_id: str, background_tasks: BackgroundTasks):\n    \"\"\"\"\"\"\n    기존 요약 기반으로 에러 분석 실행\n    \n    이미 요약 분석이 완료된 경우, 추가로 에러 분석을 실행합니다.\n    LLM을 사용하여 문제를 분석하고 패치를 제안합니다.\n    \"\"\"\"\"\"\n    if analysis_id not in gcode_analysis_store:\n        raise HTTPException(status_code=404, detail=\"\"분석을 찾을 수 없습니다.\"\")\n    \n    data = gcode_analysis_store[analysis_id]\n    \n    if data[\"\"status\"\"] not in [\"\"completed\"\", \"\"summary_completed\"\"]:\n        raise HTTPException(status_code=400, detail=\"\"요약 분석이 완료되지 않았습니다. 먼저 요약 분석을 실행하세요.\"\")\n    \n    if data.get(\"\"analysis_mode\"\") == \"\"full\"\" and data[\"\"status\"\"] == \"\"completed\"\":\n        return {\n            \"\"analysis_id\"\": analysis_id,\n            \"\"status\"\": \"\"already_analyzed\"\",\n            \"\"message\"\": \"\"이미 전체 분석이 완료되었습니다.\"\",\n            \"\"result\"\": data.get(\"\"result\"\")\n        }\n    \n    # 에러 분석 모드로 전환\n    data[\"\"status\"\"] = \"\"running_error_analysis\"\"\n    data[\"\"analysis_mode\"\"] = \"\"error_analysis\"\"\n    \n    logger.info(f\"\"[GCode] Error analysis started: {analysis_id}\"\")\n    \n    # 백그라운드에서 에러 분석 실행\n    background_tasks.add_task(run_gcode_error_analysis_task, analysis_id)\n    \n    return {\n        \"\"analysis_id\"\": analysis_id,\n        \"\"status\"\": \"\"running_error_analysis\"\",\n        \"\"message\"\": \"\"에러 분석이 시작되었습니다. (LLM 사용)\"\",\n        \"\"stream_url\"\": f\"\"/api/v1/gcode/analysis/{analysis_id}/stream\"\"\n    }\n\n\n@router.get(\"\"/analysis/{analysis_id}\"\")''''''\n\ncontent = content.replace(insert_after, new_endpoints)\n\n# Write back\nwith open(''c:/Users/USER/factor_AI_python/gcode_analyzer/api/router.py'', ''w'', encoding=''utf-8'') as f:\n    f.write(content)\n\nprint(''Added new endpoints'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\n# Read the file\nwith open(''c:/Users/USER/factor_AI_python/gcode_analyzer/api/router.py'', ''r'', encoding=''utf-8'') as f:\n    content = f.read()\n\n# Append new background tasks at the end\nnew_tasks = ''''''\n\nasync def run_gcode_summary_task(analysis_id: str):\n    \"\"\"\"\"\"백그라운드에서 G-code 요약만 실행 (LLM 없음)\"\"\"\"\"\"\n    from gcode_analyzer.analyzer import run_analysis\n\n    data = gcode_analysis_store[analysis_id]\n    data[\"\"status\"\"] = \"\"running\"\"\n\n    try:\n        logger.info(f\"\"[GCode] Running summary analysis: {analysis_id}\"\")\n\n        # 요약만 분석 실행\n        result = await run_analysis(\n            file_path=data[\"\"temp_file\"\"],\n            filament_type=data.get(\"\"filament_type\"\"),\n            printer_info=data.get(\"\"printer_info\"\"),\n            auto_approve=False,\n            analysis_mode=\"\"summary_only\"\"  # 요약만 모드\n        )\n\n        # 결과 저장\n        data[\"\"status\"\"] = \"\"summary_completed\"\"\n        data[\"\"progress\"\"] = 1.0\n        data[\"\"current_step\"\"] = \"\"summary_completed\"\"\n        data[\"\"comprehensive_summary\"\"] = result.get(\"\"comprehensive_summary\"\")\n        data[\"\"result\"\"] = {\n            \"\"comprehensive_summary\"\": result.get(\"\"comprehensive_summary\"\"),\n            \"\"summary\"\": result.get(\"\"summary\"\"),\n            \"\"timeline\"\": result.get(\"\"timeline\"\", [])\n        }\n        data[\"\"timeline\"\"] = result.get(\"\"timeline\"\", [])\n\n        logger.info(f\"\"[GCode] Summary analysis completed: {analysis_id}\"\")\n\n    except Exception as e:\n        data[\"\"status\"\"] = \"\"error\"\"\n        data[\"\"error\"\"] = str(e)\n        logger.error(f\"\"[GCode] Summary analysis failed: {analysis_id} - {e}\"\")\n        import traceback\n        data[\"\"error_trace\"\"] = traceback.format_exc()\n\n\nasync def run_gcode_error_analysis_task(analysis_id: str):\n    \"\"\"\"\"\"백그라운드에서 에러 분석 실행 (기존 요약 기반)\"\"\"\"\"\"\n    from gcode_analyzer.analyzer import run_error_analysis_only\n\n    data = gcode_analysis_store[analysis_id]\n\n    try:\n        logger.info(f\"\"[GCode] Running error analysis: {analysis_id}\"\")\n\n        # 에러 분석 실행 (기존 파싱 결과 활용)\n        result = await run_error_analysis_only(\n            file_path=data[\"\"temp_file\"\"],\n            filament_type=data.get(\"\"filament_type\"\"),\n            printer_info=data.get(\"\"printer_info\"\"),\n            existing_summary=data.get(\"\"comprehensive_summary\"\")\n        )\n\n        # 결과 저장\n        data[\"\"status\"\"] = \"\"completed\"\"\n        data[\"\"progress\"\"] = 1.0\n        data[\"\"current_step\"\"] = \"\"completed\"\"\n        data[\"\"result\"\"] = {\n            \"\"comprehensive_summary\"\": data.get(\"\"comprehensive_summary\"\"),\n            \"\"final_summary\"\": result.get(\"\"final_summary\"\", {}),\n            \"\"issues_found\"\": result.get(\"\"issues_found\"\", []),\n            \"\"patch_plan\"\": result.get(\"\"patch_plan\"\"),\n            \"\"timeline\"\": result.get(\"\"timeline\"\", []),\n            \"\"token_usage\"\": result.get(\"\"token_usage\"\", {})\n        }\n        # 타임라인 병합\n        existing_timeline = data.get(\"\"timeline\"\", [])\n        new_timeline = result.get(\"\"timeline\"\", [])\n        data[\"\"timeline\"\"] = existing_timeline + new_timeline\n\n        logger.info(f\"\"[GCode] Error analysis completed: {analysis_id}\"\")\n\n    except Exception as e:\n        data[\"\"status\"\"] = \"\"error\"\"\n        data[\"\"error\"\"] = str(e)\n        logger.error(f\"\"[GCode] Error analysis failed: {analysis_id} - {e}\"\")\n        import traceback\n        data[\"\"error_trace\"\"] = traceback.format_exc()\n''''''\n\ncontent = content.rstrip() + new_tasks\n\n# Write back\nwith open(''c:/Users/USER/factor_AI_python/gcode_analyzer/api/router.py'', ''w'', encoding=''utf-8'') as f:\n    f.write(content)\n\nprint(''Added background tasks'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\nimport sys\nsys.path.insert(0, ''c:/Users/USER/factor_AI_python'')\n\n# 문법 체크\ntry:\n    from gcode_analyzer.gcode_summary_analyzer import GCodeSummaryAnalyzer, analyze_gcode_summary\n    print(''gcode_summary_analyzer: OK'')\nexcept Exception as e:\n    print(f''gcode_summary_analyzer: ERROR - {e}'')\n\ntry:\n    from gcode_analyzer.workflow.state import AnalysisState\n    print(''workflow.state: OK'')\nexcept Exception as e:\n    print(f''workflow.state: ERROR - {e}'')\n\ntry:\n    from gcode_analyzer.workflow.nodes import parse_node, comprehensive_summary_node, analyze_events_node\n    print(''workflow.nodes: OK'')\nexcept Exception as e:\n    print(f''workflow.nodes: ERROR - {e}'')\n\ntry:\n    from gcode_analyzer.workflow.graph import compile_workflow\n    print(''workflow.graph: OK'')\nexcept Exception as e:\n    print(f''workflow.graph: ERROR - {e}'')\n\ntry:\n    from gcode_analyzer.analyzer import run_analysis, run_error_analysis_only\n    print(''analyzer: OK'')\nexcept Exception as e:\n    print(f''analyzer: ERROR - {e}'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\nimport sys\nsys.path.insert(0, ''c:/Users/USER/factor_AI_python'')\n\nfrom gcode_analyzer.gcode_summary_analyzer import analyze_gcode_summary\nfrom gcode_analyzer.parser import parse_gcode\n\n# 샘플 G-code 파일 분석\nfile_path = ''c:/Users/USER/factor_AI_python/tests/fixtures/sample.gcode''\n\nprint(''파싱 중...'')\nparsed_lines = parse_gcode(file_path)\nprint(f''총 {len(parsed_lines)}줄'')\n\nprint(''\\n요약 분석 중...'')\nsummary = analyze_gcode_summary(parsed_lines, file_path)\n\nprint(''\\n=== 종합 요약 결과 ==='')\nprint(f''파일: {summary.file_name}'')\nprint(f''총 라인: {summary.total_lines:,}줄'')\nprint(f''슬라이서: {summary.slicer_info}'')\nprint(f''필라멘트: {summary.filament_type}'')\nprint()\nprint(''--- 온도 ---'')\nprint(f''노즐: {summary.temperature.nozzle_min}°C ~ {summary.temperature.nozzle_max}°C (평균: {summary.temperature.nozzle_avg:.1f}°C)'')\nprint(f''베드: {summary.temperature.bed_min}°C ~ {summary.temperature.bed_max}°C'')\nprint(f''온도 변경: {summary.temperature.nozzle_changes}회'')\nprint()\nprint(''--- 속도 ---'')\nprint(f''속도 범위: {summary.feed_rate.min_speed:.0f} ~ {summary.feed_rate.max_speed:.0f} mm/min'')\nprint(f''평균 속도: {summary.feed_rate.avg_speed:.0f} mm/min'')\nprint()\nprint(''--- 레이어 ---'')\nprint(f''총 레이어: {summary.layer.total_layers}층'')\nprint(f''레이어 높이: {summary.layer.avg_layer_height:.2f}mm'')\nprint()\nprint(''--- 익스트루전 ---'')\nprint(f''총 익스트루전: {summary.extrusion.total_extrusion:.2f}mm'')\nprint(f''필라멘트 사용량: {summary.extrusion.total_filament_used:.2f}m'')\nprint(f''리트랙션: {summary.extrusion.retraction_count}회'')\nprint()\nprint(''--- 서포트 ---'')\nprint(f''서포트 사용: {\"\"예\"\" if summary.support.has_support else \"\"아니오\"\"}'')\nif summary.support.has_support:\n    print(f''서포트 비율: {summary.support.support_ratio:.1f}%'')\nprint()\nprint(''--- 예상 시간 ---'')\nprint(f''총 시간: {summary.print_time.formatted_time}'')\nprint()\nprint(''--- 구간 ---'')\nprint(f''시작 G-code: {summary.start_gcode_lines}줄'')\nprint(f''본문: {summary.body_lines}줄'')\nprint(f''종료 G-code: {summary.end_gcode_lines}줄'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\nimport sys\nsys.path.insert(0, ''c:/Users/USER/factor_AI_python'')\n\nfrom gcode_analyzer.gcode_summary_analyzer import analyze_gcode_summary\nfrom gcode_analyzer.parser import parse_gcode\n\n# 더 큰 G-code 파일 분석\nfile_path = ''c:/Users/USER/factor_AI_python/output/uploaded_model_1761418759764_1761418759.gcode''\n\nprint(''Parsing...'')\nparsed_lines = parse_gcode(file_path)\nprint(f''Total lines: {len(parsed_lines):,}'')\n\nprint(''\\nAnalyzing summary...'')\nsummary = analyze_gcode_summary(parsed_lines, file_path)\n\nprint(''\\n=== COMPREHENSIVE SUMMARY ==='')\nprint(f''File: {summary.file_name}'')\nprint(f''Total lines: {summary.total_lines:,}'')\nprint(f''Slicer: {summary.slicer_info}'')\nprint(f''Filament: {summary.filament_type}'')\nprint()\nprint(''--- Temperature ---'')\nprint(f''Nozzle: {summary.temperature.nozzle_min}C ~ {summary.temperature.nozzle_max}C (avg: {summary.temperature.nozzle_avg:.1f}C)'')\nprint(f''Bed: {summary.temperature.bed_min}C ~ {summary.temperature.bed_max}C'')\nprint(f''Temp changes: {summary.temperature.nozzle_changes}'')\nprint()\nprint(''--- Speed ---'')\nprint(f''Range: {summary.feed_rate.min_speed:.0f} ~ {summary.feed_rate.max_speed:.0f} mm/min'')\nprint(f''Average: {summary.feed_rate.avg_speed:.0f} mm/min'')\nprint()\nprint(''--- Layer ---'')\nprint(f''Total layers: {summary.layer.total_layers}'')\nprint(f''Layer height: {summary.layer.avg_layer_height:.2f}mm'')\nprint()\nprint(''--- Extrusion ---'')\nprint(f''Total extrusion: {summary.extrusion.total_extrusion:.2f}mm'')\nprint(f''Filament used: {summary.extrusion.total_filament_used:.2f}m'')\nprint(f''Retractions: {summary.extrusion.retraction_count}'')\nprint()\nprint(''--- Support ---'')\nprint(f''Has support: {summary.support.has_support}'')\nif summary.support.has_support:\n    print(f''Support ratio: {summary.support.support_ratio:.1f}%'')\nprint()\nprint(''--- Print time ---'')\nprint(f''Estimated: {summary.print_time.formatted_time}'')\nprint()\nprint(''--- Sections ---'')\nprint(f''Start G-code: {summary.start_gcode_lines} lines'')\nprint(f''Body: {summary.body_lines} lines'')\nprint(f''End G-code: {summary.end_gcode_lines} lines'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"\nimport sys\nsys.path.insert(0, ''c:/Users/USER/factor_AI_python'')\n\n# 노트북 구조 검증\nimport json\nwith open(''c:/Users/USER/factor_AI_python/tests/gcode_workflow_test.ipynb'', ''r'', encoding=''utf-8'') as f:\n    nb = json.load(f)\n\nprint(f''노트북 셀 수: {len(nb[\"\"cells\"\"])}개'')\nprint(f''커널: {nb[\"\"metadata\"\"][\"\"kernelspec\"\"][\"\"display_name\"\"]}'')\nprint()\n\n# 모듈 임포트 테스트\nprint(''모듈 임포트 테스트...'')\ntry:\n    from gcode_analyzer.workflow.nodes import (\n        parse_node, \n        comprehensive_summary_node,\n        analyze_events_node,\n        llm_analyze_node,\n        final_summary_node,\n        apply_patch_node\n    )\n    print(''  ✅ workflow.nodes'')\nexcept Exception as e:\n    print(f''  ❌ workflow.nodes: {e}'')\n\ntry:\n    from gcode_analyzer.analyzer import run_analysis, _create_initial_state\n    print(''  ✅ analyzer'')\nexcept Exception as e:\n    print(f''  ❌ analyzer: {e}'')\n\ntry:\n    from gcode_analyzer.api.router import _create_dashboard_response, DashboardSummaryResponse\n    print(''  ✅ api.router'')\nexcept Exception as e:\n    print(f''  ❌ api.router: {e}'')\n\nprint()\nprint(''✅ 노트북 준비 완료!'')\n\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"from gcode_analyzer.llm.printing_summary import generate_printing_summary; print(''printing_summary import OK'')\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"from gcode_analyzer.analyzer import run_analysis; print(''analyzer import OK'')\")",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" teststest_rate_limiter.py)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" tests/test_rate_limiter.py)",
      "Bash(\"C:\\Users\\USER\\anaconda3\\python.exe\" -c \"import sys; sys.path.insert(0, ''c:/Users/USER/factor_AI_python''); from gcode_analyzer.rate_limiter import GeminiRateLimiter, RateLimitConfig, RateLimitError; import asyncio; config = RateLimitConfig(user_rpm=5, user_daily_limit=10); limiter = GeminiRateLimiter(config); print(''Rate Limiter created successfully''); print(f''Stats: {limiter.get_stats()}'')\")"
    ],
    "deny": [],
    "ask": []
  }
}
